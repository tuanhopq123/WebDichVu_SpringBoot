<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán dịch vụ | Dịch Vụ Tại Nhà</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="/css/payment.css" rel="stylesheet">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        .service-list { margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 0.95rem; }
        .service-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #ddd; }
        .service-item:last-child { border-bottom: none; }
        .total-row { font-weight: 700; font-size: 1.1rem; color: #e74c3c; margin-top: 10px; padding-top: 8px; border-top: 2px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="payment-container">
            <div class="payment-header">
                <div class="payment-logo">
                    <img src="/assets/logo/Ho_Anh_Tuan.png" alt="Logo" style="height: 50px; border-radius: 17px;">
                    <h2>Thanh toán dịch vụ</h2>
                </div>
                <div class="payment-id">
                    <span>Mã đơn: #<span id="order-id"></span></span>
                </div>
            </div>

            <div class="payment-body">
                <div class="payment-summary">
                    <div class="order-details">
                        <h3><i class="fas fa-clipboard-list"></i> Chi tiết đơn hàng</h3>
                        
                        <!-- DANH SÁCH NHIỀU DỊCH VỤ -->
                        <div class="service-list" id="service-list"></div>

                        <div class="detail-item">
                            <span class="detail-label">Ngày thực hiện:</span>
                            <span class="detail-value" id="booking-date"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Giờ:</span>
                            <span class="detail-value" id="booking-time"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Địa chỉ:</span>
                            <span class="detail-value" id="address"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Tổng tiền:</span>
                            <span class="detail-value price" id="amount" style="font-size:1.3rem; color:#e74c3c; font-weight:700;"></span>
                        </div>
                    </div>

                    <div class="customer-details">
                        <h3><i class="fas fa-user"></i> Thông tin khách hàng</h3>
                        <div class="detail-item"><span class="detail-label">Số điện thoại:</span> <span id="phone"></span></div>
                        <div class="detail-item"><span class="detail-label">Ghi chú:</span> <span id="notes">Không có</span></div>
                        <div class="detail-item">
                            <span class="detail-label">Trạng thái:</span>
                            <span class="detail-value" id="payment-status">
                                <span class="status-tag status-unpaid"><i class="fas fa-clock"></i> Chưa thanh toán</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="bank-transfer-section">
                    <h3><i class="fas fa-university"></i> Thông tin chuyển khoản</h3>
                    <div class="bank-info">
                        <p><i class="fas fa-building-columns"></i> <strong>Ngân hàng:</strong> OCB</p>
                        <p><i class="fas fa-credit-card"></i> <strong>Số tài khoản:</strong>
                            <div class="copy-field">
                                <input type="text" value="CASSTUANHO" id="account-number" readonly>
                                <button onclick="copyToClipboard('account-number')">Sao chép</button>
                            </div>
                        </p>
                        <p><i class="fas fa-user"></i> <strong>Chủ tài khoản:</strong> HO ANH TUAN</p>
                        <p><i class="fas fa-money-bill-wave"></i> <strong>Số tiền:</strong>
                            <div class="copy-field">
                                <input type="text" id="amount-input" readonly>
                                <button onclick="copyToClipboard('amount-input')">Sao chép</button>
                            </div>
                        </p>
                        <p><i class="fas fa-comment"></i> <strong>Nội dung chuyển khoản:</strong>
                            <div class="copy-field">
                                <input type="text" id="transfer-desc" readonly style="font-family: monospace; letter-spacing: 1px;">
                                <button onclick="copyToClipboard('transfer-desc')">Sao chép</button>
                            </div>
                        </p>
                    </div>
                    <div class="transfer-note">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Quan trọng:</strong> Vui lòng chuyển <u>đúng nội dung</u> và <u>đúng số tiền</u> để hệ thống xác nhận tự động.
                    </div>
                </div>

                <div class="qr-container" id="qrcode-container">
                    <h3>Quét mã QR để thanh toán nhanh</h3>
                    <div id="qrcode"></div>
                    <div class="timer-container">
                        <i class="fas fa-hourglass-half"></i>
                        <span>Thời gian còn lại: <span id="countdown-timer">30:00</span></span>
                    </div>
                </div>

                <button id="generate-qr-btn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Tạo lại mã QR (nếu hết hạn)
                </button>

                <div class="transaction-status" id="transaction-status-container">
                    <div class="status-message warning" id="transaction-status">
                        <i class="fas fa-spinner fa-spin"></i> Đang kiểm tra thanh toán...
                    </div>
                </div>

                <div class="button-container" style="text-align: center; margin-top: 2rem;">
                    <a href="/my_bookings.html" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> Quay lại danh sách đơn
                    </a>
                </div>
            </div>
        </div>
    </div>
<script src="/js/notification.js?v=1.3"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
let orderIds = [];

const idsParam = urlParams.get('order_ids');
if (idsParam) {
    orderIds = idsParam.split(',');
} else {
    const singleId = urlParams.get('order_id') || urlParams.get('booking_id');
    if (singleId) orderIds.push(singleId);
}

// Global Variables
let totalAmount = 0;
let transactionCode = ""; 
let checkInterval = null;
let countdownInterval = null;
let isPaid = false;

const formatMoney = (amount) => new Intl.NumberFormat('vi-VN').format(amount) + 'đ';

function copyToClipboard(id) {
  const el = document.getElementById(id);
  el.select();
  navigator.clipboard.writeText(el.value).then(() => {
      const btn = el.nextElementSibling;
      const originalText = btn.textContent;
      btn.textContent = "Đã chép";
      setTimeout(() => btn.textContent = originalText, 1000);
  });
}

async function loadOrders() {
    if (orderIds.length === 0) {
        alert("Không tìm thấy mã đơn hàng.");
        window.location.href = '/home.html';
        return;
    }

    const token = localStorage.getItem('jwtToken');
    if (!token) return window.location.href = '/login.html';

    try {
        const promises = orderIds.map(id => 
            fetch(`/api/orders/${id}`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(res => {
                if(!res.ok) throw new Error("Lỗi tải đơn " + id);
                return res.json();
            })
        );
        
        const orders = await Promise.all(promises);
        
        const serviceListEl = document.getElementById('service-list');
        serviceListEl.innerHTML = "";
        totalAmount = 0;

        orders.forEach(order => {
            totalAmount += order.tongTien;
            
            const div = document.createElement('div');
            div.className = 'service-item';
            
            div.innerHTML = `
                <span>${order.service.tenDichVu} <small style="color:#888;">(#${order.id})</small></span>
                <span style="font-weight:600;">${formatMoney(order.tongTien)}</span>
            `;
            serviceListEl.appendChild(div);
        });

        // Điền thông tin chung
        const firstOrder = orders[0];
        document.getElementById('booking-date').textContent = new Date(firstOrder.thoiGianDat).toLocaleDateString('vi-VN');
        document.getElementById('booking-time').textContent = new Date(firstOrder.thoiGianDat).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('address').textContent = firstOrder.diaChiDichVu;

        document.getElementById('phone').textContent = firstOrder.sdt;
        document.getElementById('notes').textContent = firstOrder.notes || 'Không có';
        document.getElementById('amount').textContent = formatMoney(totalAmount);
        document.getElementById('amount-input').value = totalAmount;
        
        if (orders.length > 1) {
            document.getElementById('order-id').textContent = `Tổng ${orders.length} đơn hàng`;
        } else {
            document.getElementById('order-id').textContent = firstOrder.id;
        }

        const allIdsString = orderIds.join(' ');
        // PAY + ID Đơn + T + 4 Số Random
        const randomSuffix = Math.floor(1000 + Math.random() * 9000);
        transactionCode = `PAY${allIdsString}T${randomSuffix}`; 
        document.getElementById('transfer-desc').value = transactionCode;

        generateQR(totalAmount, transactionCode);
        
        checkInterval = setInterval(checkPaymentStatus, 3000);

    } catch (e) {
        console.error(e);
        alert("Có lỗi khi tải thông tin đơn hàng.");
    }
}

function generateQR(amount, desc) {
    const qrDiv = document.getElementById("qrcode");
    qrDiv.innerHTML = "";
    
    // Tạo link VietQR (OCB)
    const qrUrl = `https://img.vietqr.io/image/OCB-CASSTUANHO-compact.png?amount=${amount}&addInfo=${encodeURIComponent(desc)}&accountName=HO%20ANH%20TUAN`;
    
    const img = document.createElement('img');
    img.src = qrUrl;
    img.style.width = "100%";
    img.style.maxWidth = "250px";
    img.style.borderRadius = "8px";
    img.style.border = "1px solid #ddd";
    
    qrDiv.appendChild(img);
    
    startCountdown();
}

function startCountdown() {
    let time = 15 * 60; // 15 phút
    const timerEl = document.getElementById('countdown-timer');
    const container = document.getElementById('qrcode-container');
    const btn = document.getElementById('generate-qr-btn');
    
    clearInterval(countdownInterval);
    container.style.display = 'block';
    btn.style.display = 'none';

    countdownInterval = setInterval(() => {
        const m = Math.floor(time / 60).toString().padStart(2, '0');
        const s = (time % 60).toString().padStart(2, '0');
        timerEl.textContent = `${m}:${s}`;
        
        if (--time < 0) {
            clearInterval(countdownInterval);
            clearInterval(checkInterval);
            container.style.display = 'none';
            btn.style.display = 'block';
            document.getElementById('transaction-status').innerHTML = '<span style="color:red">Hết thời gian. Vui lòng tạo mã mới.</span>';
        }
    }, 1000);
}

// Nút tạo lại QR khi hết giờ
document.getElementById('generate-qr-btn').onclick = () => {
    const newRandom = Math.floor(1000 + Math.random() * 9000);
    const firstId = transactionCode.split('T')[0].replace('PAY', '');
    transactionCode = `PAY${firstId}T${newRandom}`;
    document.getElementById('transfer-desc').value = transactionCode;
    
    generateQR(totalAmount, transactionCode);
    checkInterval = setInterval(checkPaymentStatus, 3000);
    document.getElementById('transaction-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...';
};


async function checkPaymentStatus() {
    if (isPaid) return;

    const token = localStorage.getItem('jwtToken');
    if (!token) return;

    try {
        // Lấy ID đơn hàng để kiểm tra
        const checkOrderId = orderIds[0]; 

        const res = await fetch(`/api/orders/${checkOrderId}`, {
            method: 'GET',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (res.ok) {
            const order = await res.json();

            if (order.paymentStatus === 'PAID') {
                isPaid = true;
                clearInterval(checkInterval);
                clearInterval(countdownInterval);
                
                // UI Update: Hiển thị thành công
                document.getElementById('payment-status').innerHTML = '<span class="status-tag status-paid" style="background:#d4edda; color:#155724; padding:5px 10px; border-radius:15px;"><i class="fas fa-check-circle"></i> Đã thanh toán</span>';
                document.getElementById('transaction-status').innerHTML = '<div class="status-message success" style="color:green; font-weight:bold; font-size:1.1rem; padding: 10px; background: #e8f5e9; border-radius: 8px;"><i class="fas fa-check-circle"></i> Thanh toán thành công! Đang chuyển hướng...</div>';

                setTimeout(() => {
                    window.location.href = `/thank_you.html?msg=paid_success`;
                }, 2000);
            }
        }
    } catch (e) {
        console.error("Đang đợi thanh toán...", e);
    }
}

document.addEventListener("DOMContentLoaded", loadOrders);
</script>
</body>
</html>