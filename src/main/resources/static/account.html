<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì s∆° C√° nh√¢n - D·ªãch v·ª• T·∫°i Nh√†</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Icons&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="/css/style_index.css" rel="stylesheet"> <link href="/css/style_account.css" rel="stylesheet"> 
    <link rel="icon" href="data:," />
</head>
<body>
    <div id="alert-box" class="alert"></div>

    <header class="main-header">
        <div class="container header-container">
            <a href="/home.html" class="logo">
                <img src="/assets/logo/Ho_Anh_Tuan.png" alt="Logo" style="height: 50px; border-radius: 17px;">
                <span class="logo-text">D·ªãch v·ª• T·∫°i Nh√†</span>
            </a>
            <nav class="main-nav">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="/home.html" class="nav-link">Trang ch·ªß</a></li>
                    <li class="nav-item"><a href="/introduce.html" class="nav-link">Gi·ªõi thi·ªáu</a></li>
                    <li class="nav-item"><a href="/services.html" class="nav-link">D·ªãch v·ª•</a></li>
                    <li class="nav-item"><a href="/service_price_list.html" class="nav-link">B·∫£ng gi√°</a></li>
                    <li class="nav-item"><a href="/contact.html" class="nav-link">Li√™n h·ªá</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="auth-section"> </div>
                <button class="hamburger" aria-label="Menu">
                    <span class="bar"></span><span class="bar"></span><span class="bar"></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="breadcrumb">
                <a href="/home.html"><i class="fas fa-home"></i> Trang ch·ªß</a>
                <span class="separator"><i class="fas fa-angle-right"></i></span>
                <span>H·ªì s∆° C√° nh√¢n</span>
            </div>

            <div class="profile-container">
                <!-- Profile Display -->
                <div class="booking-container">
                    <div class="booking-header">
                        <h2><i class="fas fa-user"></i> H·ªì s∆° C√° nh√¢n</h2>
                        <p class="subtitle">Qu·∫£n l√Ω th√¥ng tin c√° nh√¢n c·ªßa b·∫°n t·∫°i ƒë√¢y.</p>
                    </div>
                    <div class="booking-wrapper">
                        <div class="profile-image" id="profile-image">
                            <div class="avatar-container">
                                <img src="/assets/avatar/default-avatar.png" alt="Avatar" class="avatar-img" id="avatar-img">
                            </div>
                            <label for="avatar-upload" class="avatar-upload-label">
                                <i class="fas fa-camera"></i> Thay ƒë·ªïi ·∫£nh
                            </label>
                            <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                            <div id="image-preview" style="margin-top: 10px;">
                                <img id="preview-img" src="" alt="·∫¢nh xem tr∆∞·ªõc" style="display: none; max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px;">
                            </div>
                        </div>
                        <div class="profile-info" id="profile-info">
                            <!-- Th√¥ng tin s·∫Ω ƒë∆∞·ª£c t·∫£i ƒë·ªông t·ª´ API -->
                        </div>
                    </div>
                </div>

                <!-- Update Form -->
                <div class="booking-container booking-form-container">
                    <div class="booking-form-title">
                        <i class="fas fa-edit"></i> C·∫≠p nh·∫≠t Th√¥ng tin
                    </div>
                    <form class="booking-form" id="update-profile-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="full-name">H·ªç v√† T√™n <span class="required">*</span></label>
                                <input type="text" id="full-name" required placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" readonly placeholder="Email kh√¥ng th·ªÉ thay ƒë·ªïi">
                                <small class="form-text">Email ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ƒëƒÉng nh·∫≠p v√† kh√¥i ph·ª•c m·∫≠t kh·∫©u</small>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label for="phone">S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                            <input type="tel" id="phone" required placeholder="VD: 0123456789">
                            <small class="form-text">S·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ li√™n h·ªá ƒë·∫∑t l·ªãch d·ªãch v·ª•</small>
                        </div>
                        <div class="form-group full-width">
                            <label for="address">ƒê·ªãa ch·ªâ <span class="required">*</span></label>
                            <input type="text" id="address" required placeholder="VD: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM">
                            <small class="form-text">ƒê·ªãa ch·ªâ nh·∫≠n d·ªãch v·ª• t·∫°i nh√†</small>
                        </div>
                        <button type="submit" class="cta-btn">
                            <span class="btn-text">L∆∞u Thay ƒê·ªïi</span>
                            <i class="fas fa-save"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-column">
                <a href="/home.html" class="footer-logo">
                    <img src="/assets/logo/Ho_Anh_Tuan.png" alt="Logo" class="footer-logo-img">
                    <span>D·ªãch v·ª• T·∫°i Nh√†</span>
                </a>
                <p class="footer-desc">Cung c·∫•p c√°c d·ªãch v·ª• t·∫°i nh√† ch·∫•t l∆∞·ª£ng cao, uy t√≠n v√† chuy√™n nghi·ªáp v·ªõi ƒë·ªôi ng≈© k·ªπ thu·∫≠t vi√™n gi√†u kinh nghi·ªám.</p>
                <div class="social-links">
                    <a href="#" class="social-link" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="social-link" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
                    <a href="#" class="social-link" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
            <div class="footer-column">
                <h4><i class="fas fa-compass"></i> ƒêi·ªÅu h∆∞·ªõng</h4>
                <ul class="footer-links">
                    <li><a href="/home.html"><i class="fas fa-home"></i> Trang ch·ªß</a></li>
                    <li><a href="/introduce.html"><i class="fas fa-info-circle"></i> Gi·ªõi thi·ªáu</a></li>
                    <li><a href="/services.html"><i class="fas fa-cogs"></i> D·ªãch v·ª•</a></li>
                    <li><a href="/service_price_list.html"><i class="fas fa-tags"></i> B·∫£ng gi√°</a></li>
                    <li><a href="/contact.html"><i class="fas fa-phone"></i> Li√™n h·ªá</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h4><i class="fas fa-tools"></i> D·ªãch v·ª•</h4>
                <ul class="footer-links" id="footer-services">
                    <!-- Services s·∫Ω ƒë∆∞·ª£c load ƒë·ªông -->
                </ul>
            </div>
            <div class="footer-column">
                <h4><i class="fas fa-headset"></i> H·ªó tr·ª£</h4>
                <ul class="footer-links">
                    <li><a href="/terms.html"><i class="fas fa-file-contract"></i> ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
                    <li><a href="/privacy.html"><i class="fas fa-shield-alt"></i> Ch√≠nh s√°ch b·∫£o m·∫≠t</a></li>
                    <li><a href="/faq.html"><i class="fas fa-question-circle"></i> C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 D·ªãch v·ª• T·∫°i Nh√†. All rights reserved. Thi·∫øt k·∫ø b·ªüi <a href="#">H·ªì Anh Tu·∫•n</a></p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="/js/notification.js?v=1.2"></script>
    <script>
        // üîπ GLOBAL HELPER: X·ª≠ l√Ω l·ªói load ·∫£nh (global ƒë·ªÉ d√πng ·ªü nhi·ªÅu n∆°i)
        function handleImageError(img, originalSrc) {
            console.error('‚ùå L·ªói t·∫£i ·∫£nh ban ƒë·∫ßu:', img.src);
            if (img.src.includes('avatar.png')) return;  // Tr√°nh loop n·∫øu ƒë√£ default

            // Hi·ªÉn th·ªã loading ng·∫Øn (3s) thay v√¨ error ngay
            const loadingTimeout = showAlert('ƒêang t·∫£i l·∫°i ·∫£nh ƒë·∫°i di·ªán...', 'info');

            // Retry sau 2 gi√¢y (fix delay server static cache)
            setTimeout(() => {
                console.log('üîÑ Retry load ·∫£nh:', originalSrc);
                const retrySrc = originalSrc + '?t=' + Date.now();  // Cache-buster m·ªõi
                img.src = retrySrc;
                img.onerror = null;  // Reset ƒë·ªÉ tr√°nh loop
                img.onload = () => {  // X√°c nh·∫≠n load th√†nh c√¥ng
                    console.log('‚úÖ Retry th√†nh c√¥ng!');
                    clearTimeout(loadingTimeout);  // Clear loading alert
                    // Kh√¥ng show success alert ƒë·ªÉ tr√°nh spam, ch·ªâ log
                    // N·∫øu mu·ªën: showAlert('·∫¢nh ƒë√£ t·∫£i th√†nh c√¥ng!', 'success');
                };
                img.onerror = () => {  // Fallback ch·ªâ n·∫øu retry fail (sau onload)
                    console.error('‚ùå Retry fail, fallback default');
                    img.src = '/assets/avatar/default-avatar.png';
                    clearTimeout(loadingTimeout);  // Clear loading tr∆∞·ªõc error
                    showAlert('Kh√¥ng th·ªÉ t·∫£i ·∫£nh. S·ª≠ d·ª•ng ·∫£nh m·∫∑c ƒë·ªãnh.', 'error');
                };
            }, 2000);  // 2 gi√¢y delay ƒë·ªÉ server sync file
        }

        // üîπ ALERT SYSTEM - H·ªá th·ªëng hi·ªÉn th·ªã th√¥ng b√°o (s·ª≠a ƒë·ªÉ c√≥ timeout id cho clear)
        function showAlert(message, type = 'info') {
            let alertBox = document.getElementById('alert-box');
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'alert-box';
                alertBox.className = 'alert';
                document.body.insertBefore(alertBox, document.body.firstChild);
            }
            
            alertBox.className = `alert ${type === 'success' ? 'success-alert' : type === 'error' ? 'error-alert' : 'info-alert'}`;
            alertBox.innerHTML = `
                <div class="alert-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="close-alert" aria-label="ƒê√≥ng"><i class="fas fa-times"></i></button>
            `;
            alertBox.style.display = 'flex';

            // Tr·∫£ v·ªÅ timeout id ƒë·ªÉ clear n·∫øu c·∫ßn
            const timeoutId = setTimeout(() => { 
                if (alertBox) alertBox.style.display = 'none'; 
            }, type === 'info' ? 3000 : 5000);  // Info alert ng·∫Øn h∆°n (3s)

            alertBox.querySelector('.close-alert')?.addEventListener('click', () => {
                clearTimeout(timeoutId);
                alertBox.style.display = 'none';
            });

            return timeoutId;  // Tr·∫£ id ƒë·ªÉ clear t·ª´ ngo√†i
        }

        // üîπ AVATAR UPLOAD SYSTEM - H·ªá th·ªëng t·∫£i l√™n ·∫£nh ƒë·∫°i di·ªán
        async function setupAvatarUpload() {
            const avatarInput = document.getElementById('avatar-upload');
            const avatarImg = document.getElementById('avatar-img');
            const avatarLabel = document.querySelector('.avatar-upload-label');
            const previewImg = document.getElementById('preview-img');

            if (!avatarInput || !avatarImg || !avatarLabel || !previewImg) return;

            // G√°n onerror cho avatar img (s·ª≠ d·ª•ng global handleImageError)
            avatarImg.onerror = () => handleImageError(avatarImg, avatarImg.src);

            avatarInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file
                const validImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!validImageTypes.includes(file.type)) {
                    showAlert('Vui l√≤ng ch·ªçn file ·∫£nh (JPEG, PNG, ho·∫∑c GIF)', 'error');
                    avatarInput.value = '';
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showAlert('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'error');
                    avatarInput.value = '';
                    return;
                }

                // Preview image
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                };
                reader.readAsDataURL(file);

                // Upload image to server
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    showAlert('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
                    window.location.href = '/login.html';
                    return;
                }

                const formData = new FormData();
                formData.append('avatar', file);

                avatarLabel.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i l√™n...';
                avatarLabel.style.pointerEvents = 'none';

                try {
                    const response = await fetch('/api/users/me/avatar', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    console.log('Response status:', response.status);
                    // In ra header ƒë·ªÉ debug n·∫øu c·∫ßn
                    console.log('Response headers:', Object.fromEntries(response.headers.entries ? [...response.headers.entries()] : Object.entries(response.headers)));

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`L·ªói t·∫£i l√™n ·∫£nh: ${errorText || `HTTP ${response.status} - ${response.statusText}`}`);
                    }

                    const result = await response.json();
                    console.log('‚úÖ T·∫£i ·∫£nh th√†nh c√¥ng - Server tr·∫£ v·ªÅ:', result);

                    // --- [ƒêO·∫†N S·ª¨A QUAN TR·ªåNG] ---
                    // Ki·ªÉm tra c·∫£ 2 tr∆∞·ªùng h·ª£p: avatarURL (Backend m·ªõi) ho·∫∑c avatarUrl (Backend c≈©)
                    const serverAvatarUrl = result.avatarURL || result.avatarUrl;

                    if (serverAvatarUrl) {
                        // C·∫≠p nh·∫≠t ·∫£nh to
                        // Cloudinary kh√¥ng c·∫ßn cache-buster (?t=...) v√¨ link ·∫£nh thay ƒë·ªïi lu√¥n, nh∆∞ng gi·ªØ l·∫°i c≈©ng ko sao
                        const newSrc = serverAvatarUrl; 
                        
                        avatarImg.src = newSrc;
                        
                        // C·∫≠p nh·∫≠t lu√¥n ·∫£nh nh·ªè tr√™n g√≥c ph·∫£i m√†n h√¨nh (Header)
                        const headerAvatar = document.querySelector('.user-menu-trigger .user-avatar');
                        if (headerAvatar) headerAvatar.src = newSrc;

                        // ·∫®n ·∫£nh xem tr∆∞·ªõc
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                        
                        // Hi·ªán th√¥ng b√°o th√†nh c√¥ng
                        showAlert('·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                        
                        // G·ªçi h√†m load l·∫°i th√¥ng tin user ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu
                        await loadUserProfile();
                    } else {
                        console.error("D·ªØ li·ªáu server tr·∫£ v·ªÅ:", result);
                        throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL ·∫£nh t·ª´ server (Key kh√¥ng kh·ªõp)');
                    }
                    // -----------------------------

                } catch (error) {
                    console.error('‚ùå L·ªói t·∫£i ·∫£nh:', error);
                    showAlert(`L·ªói t·∫£i ·∫£nh: ${error.message}`, 'error');
                    // N·∫øu l·ªói th√¨ fallback v·ªÅ ·∫£nh m·∫∑c ƒë·ªãnh
                    avatarImg.src = '/assets/avatar/default-avatar.png'; 
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                } finally {
                    avatarLabel.innerHTML = '<i class="fas fa-camera"></i> Thay ƒë·ªïi ·∫£nh';
                    avatarLabel.style.pointerEvents = 'auto';
                    avatarInput.value = '';
                }
            });
        }

        // üîπ USER DROPDOWN - CLICK TO TOGGLE
        function setupUserMenuDropdown() {
            const userMenuContainer = document.querySelector('.user-menu-container');
            const userDropdown = document.querySelector('.user-dropdown');
            const userMenuTrigger = document.querySelector('.user-menu-trigger');
            
            if (!userMenuContainer || !userDropdown || !userMenuTrigger) return;

            let dropdownVisible = false;
            let timeoutId = null;

            // CLICK ƒë·ªÉ toggle
            userMenuTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                
                dropdownVisible = !dropdownVisible;
                
                if (dropdownVisible) {
                    userDropdown.style.display = 'block';
                    userMenuContainer.classList.add('active');
                    document.body.classList.add('dropdown-open');
                    userMenuTrigger.setAttribute('aria-expanded', 'true');
                } else {
                    userDropdown.style.display = 'none';
                    userMenuContainer.classList.remove('active');
                    document.body.classList.remove('dropdown-open');
                    userMenuTrigger.setAttribute('aria-expanded', 'false');
                }
                
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }
            });

            // HOVER backup
            const showDropdown = () => {
                if (timeoutId) clearTimeout(timeoutId);
                userMenuContainer.classList.add('active');
                userDropdown.style.display = 'block';
            };

            const hideDropdown = () => {
                timeoutId = setTimeout(() => {
                    if (!dropdownVisible) {
                        userDropdown.style.display = 'none';
                        userMenuContainer.classList.remove('active');
                        document.body.classList.remove('dropdown-open');
                        userMenuTrigger.setAttribute('aria-expanded', 'false');
                    }
                }, 150);
            };

            userMenuContainer.addEventListener('mouseenter', showDropdown);
            userMenuContainer.addEventListener('mouseleave', hideDropdown);
            userDropdown.addEventListener('mouseenter', showDropdown);
            userDropdown.addEventListener('mouseleave', hideDropdown);

            // CLICK NGO√ÄI ƒë·ªÉ ƒë√≥ng
            document.addEventListener('click', (e) => {
                if (!userMenuContainer.contains(e.target)) {
                    dropdownVisible = false;
                    userDropdown.style.display = 'none';
                    userMenuContainer.classList.remove('active');
                    document.body.classList.remove('dropdown-open');
                    userMenuTrigger.setAttribute('aria-expanded', 'false');
                }
            });

            // ESC ƒë·ªÉ ƒë√≥ng
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && dropdownVisible) {
                    dropdownVisible = false;
                    userDropdown.style.display = 'none';
                    userMenuContainer.classList.remove('active');
                    document.body.classList.remove('dropdown-open');
                    userMenuTrigger.setAttribute('aria-expanded', 'false');
                    userMenuTrigger.focus();
                }
            });

            // Keyboard navigation
            userMenuTrigger.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    userMenuTrigger.click();
                }
            });
        }

        // üîπ AUTH SECTION
        async function loadAuthSection() {
            const authSection = document.getElementById('auth-section');
            if (!authSection) return;

            const token = localStorage.getItem('jwtToken');
            if (token) {
                const avatarUrl = await getUserAvatarUrl();
                authSection.innerHTML = `
                    <div class="user-menu-container" role="menubar">
                        <div class="user-menu-trigger" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
                            <img src="${avatarUrl || '/assets/avatar/default-avatar.png'}" alt="Avatar ng∆∞·ªùi d√πng" class="user-avatar" id="user-avatar-img">
                            <span class="user-name" aria-label="T√†i kho·∫£n ng∆∞·ªùi d√πng">T√†i kho·∫£n</span>
                            <i class="fas fa-chevron-down dropdown-icon" aria-hidden="true"></i>
                        </div>
                        <div class="user-dropdown" role="menu">
                            <a href="/account.html" class="user-dropdown-item" role="menuitem" tabindex="-1">
                                <i class="fas fa-user"></i>
                                <span>H·ªì s∆° c√° nh√¢n</span>
                            </a>
                            <a href="/my_bookings.html" class="user-dropdown-item" role="menuitem" tabindex="-1">
                                <i class="fas fa-calendar-check"></i>
                                <span>ƒê∆°n ƒë·∫∑t d·ªãch v·ª•</span>
                            </a>
                            <a href="/change_password.html" class="user-dropdown-item" role="menuitem" tabindex="-1">
                                <i class="fas fa-key"></i>
                                <span>ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </a>
                            <div class="dropdown-divider" role="separator"></div>
                            <a href="#" class="user-dropdown-item logout" onclick="logout(event)" role="menuitem" tabindex="-1">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </a>
                        </div>
                    </div>`;

                    const initialCount = localStorage.getItem('unreadNotificationCount') || 0;
                    updateBadgeCount(initialCount);
                setupUserMenuDropdown();
                setupNotificationClick();
                // G√°n onerror cho user avatar sau khi render
                const userAvatar = document.getElementById('user-avatar-img');
                if (userAvatar) {
                    userAvatar.onerror = () => handleImageError(userAvatar, userAvatar.src);
                }
            } else {
                authSection.innerHTML = `
                    <div class="auth-buttons">
                        <a href="/login.html" class="btn btn-outline" role="button" aria-label="ƒêƒÉng nh·∫≠p">
                            <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                        </a>
                        <a href="/register.html" class="btn btn-primary" role="button" aria-label="ƒêƒÉng k√Ω t√†i kho·∫£n">
                            <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
                        </a>
                    </div>`;
            }
        }

        // S·ª≠a: S·ª≠ d·ª•ng data.avatarURL (uppercase U) ƒë·ªÉ match v·ªõi JSON t·ª´ User entity
        async function getUserAvatarUrl() {
            const token = localStorage.getItem('jwtToken');
            if (!token) return '/assets/avatar/default-avatar.png';
            try {
                const response = await fetch('/api/users/me', { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                if (!response.ok) return '/assets/avatar/default-avatar.png';
                const data = await response.json();
                console.log('Avatar URL t·ª´ API (getUserAvatarUrl):', data.avatarURL);  // Debug log
                return data.avatarURL || '/assets/avatar/default-avatar.png';  // S·ª¨A: avatarURL uppercase
            } catch (error) {
                console.error('‚ùå L·ªói l·∫•y avatarUrl:', error);
                return '/assets/avatar/default-avatar.png';
            }
        }

        function logout(event) {
            event.preventDefault();
            localStorage.removeItem('jwtToken');
            showAlert('ƒêƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
            setTimeout(() => { window.location.href = '/login.html'; }, 1500);
        }

        // üîπ LOAD USER PROFILE - T·∫£i th√¥ng tin h·ªì s∆° ng∆∞·ªùi d√πng
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng tin t√†i kho·∫£n.');
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch('/api/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`L·ªói API: ${response.status} ${response.statusText}`);
                }

                const userData = await response.json();
                console.log('‚úÖ D·ªØ li·ªáu t·ª´ API:', JSON.stringify(userData, null, 2));

                const data = userData.data ? userData.data : userData;

                // Hi·ªÉn th·ªã th√¥ng tin
                const profileInfo = document.getElementById('profile-info');
                profileInfo.innerHTML = `
                    <p><strong>T√™n:</strong> ${data.ho_ten || data.hoTen || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                    <p><strong>Email:</strong> ${data.email || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${data.sdt || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> ${data.dia_chi || data.diaChi || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                `;

                // Load avatar t·ª´ ƒë∆∞·ªùng d·∫´n tƒ©nh - S·ª¨A: S·ª≠ d·ª•ng data.avatarURL (uppercase U) ƒë·ªÉ match v·ªõi JSON t·ª´ User entity
                const profileImage = document.getElementById('avatar-img');
                if (profileImage) {
                    const avatarSrc = data.avatarURL ? data.avatarURL + '?t=' + Date.now() : '/assets/avatar/default-avatar.png';  // Cache-buster
                    profileImage.src = avatarSrc;
                    console.log('Set avatar src (loadUserProfile):', avatarSrc);  // Debug log
                    profileImage.onerror = () => handleImageError(profileImage, data.avatarURL || avatarSrc);  // G√°n v·ªõi src g·ªëc
                }

                // Update user avatar in auth section
                const userAvatar = document.querySelector('.user-menu-container .user-avatar');
                if (userAvatar) {
                    userAvatar.src = profileImage.src;
                    // onerror ƒë√£ g√°n trong loadAuthSection
                }

                // ƒêi·ªÅn form
                const form = document.getElementById('update-profile-form');
                if (form) {
                    form.querySelector('#full-name').value = data.ho_ten || data.hoTen || '';
                    form.querySelector('#email').value = data.email || '';
                    form.querySelector('#phone').value = data.sdt || '';
                    form.querySelector('#address').value = data.dia_chi || data.diaChi || '';
                }

            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫£i th√¥ng tin:', error);
                showAlert(`L·ªói t·∫£i th√¥ng tin: ${error.message}`, 'error');
                
                // Fallback avatar
                const profileImage = document.getElementById('avatar-img');
                if (profileImage) {
                    profileImage.src = '/assets/avatar/default-avatar.png';
                }
                const userAvatar = document.querySelector('.user-menu-container .user-avatar');
                if (userAvatar) {
                    userAvatar.src = '/assets/avatar/default-avatar.png';
                }
            }
        }

        // üîπ FORM SUBMIT - KH√îNG G·ª¨I EMAIL - X·ª≠ l√Ω form c·∫≠p nh·∫≠t th√¥ng tin
        document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('update-profile-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validation
                const fullName = document.getElementById('full-name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const address = document.getElementById('address').value.trim();

                if (!fullName || !phone || !address) {
                    showAlert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (*)', 'error');
                    return;
                }

                const phoneRegex = /^0\d{9}$/;
                if (!phoneRegex.test(phone.replace(/\s+/g, ''))) {
                    showAlert('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p 10 s·ªë b·∫Øt ƒë·∫ßu b·∫±ng 0', 'error');
                    document.getElementById('phone').focus();
                    return;
                }

                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    showAlert('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'error');
                    window.location.href = '/login.html';
                    return;
                }

                const submitButton = e.target.querySelector('button[type="submit"]');
                const btnText = submitButton.querySelector('.btn-text');
                const originalText = btnText.textContent;

                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';

                // G·ª¨I D·ªÆ LI·ªÜU D∆Ø·ªöI D·∫†NG JSON
                const updatedData = {
                    hoTen: fullName,
                    sdt: phone,
                    diaChi: address
                };

                console.log('G·ª≠i c·∫≠p nh·∫≠t:', updatedData);

                try {
                    const response = await fetch('/api/users/me', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('L·ªói server:', errorText);
                        if (response.status === 403) {
                            showAlert('Kh√¥ng c√≥ quy·ªÅn c·∫≠p nh·∫≠t th√¥ng tin.', 'error');
                        } else if (response.status === 401) {
                            showAlert('Phi√™n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá.', 'error');
                            localStorage.removeItem('jwtToken');
                            setTimeout(() => window.location.href = '/login.html', 1500);
                        } else {
                            showAlert(`L·ªói: ${errorText || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'}`, 'error');
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('C·∫≠p nh·∫≠t th√†nh c√¥ng:', result);
                    showAlert('Th√¥ng tin ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                    await loadUserProfile();

                } catch (error) {
                    console.error('L·ªói c·∫≠p nh·∫≠t:', error);
                    showAlert(`L·ªói c·∫≠p nh·∫≠t: ${error.message}`, 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<span class="btn-text">${originalText}</span><i class="fas fa-save"></i>`;
                }
            });
        }

        // Kh·ªüi t·∫°o
        loadAuthSection();
        loadUserProfile();
        setupAvatarUpload();
    });
    </script>
</body>
</html>