<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tất cả Dịch vụ - Dịch vụ Tại Nhà</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Icons&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="/css/style_services.css" rel="stylesheet">
    <link href="/css/chatbot.css" rel="stylesheet">
</head>
<body>
    <div id="success-alert" class="alert success-alert" style="display: none;">
        <div class="alert-content">
            <i class="fas fa-check-circle"></i>
            <span id="success-message"></span>
        </div>
        <button class="close-alert"><i class="fas fa-times"></i></button>
    </div>

    <header class="main-header">
        <div class="container header-container">
            <a href="/home.html" class="logo">
                <img src="/assets/logo/Ho_Anh_Tuan.png" alt="Logo" style="height: 50px; border-radius: 17px;">
                <span class="logo-text">Dịch vụ Tại Nhà</span>
            </a>
            <nav class="main-nav">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="/home.html" class="nav-link">Trang chủ</a></li>
                    <li class="nav-item"><a href="/introduce.html" class="nav-link">Giới thiệu</a></li>
                    <li class="nav-item"><a href="/services.html" class="nav-link active">Dịch vụ</a></li>
                    <li class="nav-item"><a href="/service_price_list.html" class="nav-link">Bảng giá</a></li>
                    <li class="nav-item"><a href="/contact.html" class="nav-link">Liên hệ</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="auth-section"></div>
                <button class="hamburger" aria-label="Menu">
                    <span class="bar"></span><span class="bar"></span><span class="bar"></span>
                </button>
            </div>
        </div>
    </header>
    <main>
        <div class="container services-page-container">
            <aside class="filter-sidebar">
                <div class="filter-group">
                    <h3>Tìm kiếm</h3>
                    <input type="search" id="search-input" placeholder="Tìm theo tên dịch vụ...">
                </div>
                <div class="filter-group">
                    <h3>Danh mục</h3>
                    <div id="category-filters" class="category-list">
                        <p>Đang tải danh mục...</p>
                    </div>
                    <button id="load-more-categories" style="display: none;">Xem thêm</button>
                </div>
                <div class="filter-group">
                    <h3>Sắp xếp theo giá</h3>
                    <select id="price-sort" class="filter-select">
                        <option value="default">Mặc định</option>
                        <option value="asc">Giá: Thấp đến Cao</option>
                        <option value="desc">Giá: Cao đến Thấp</option>
                    </select>
                </div>
                <div class="filter-group">
                    <h3>Sắp xếp theo tên</h3>
                    <select id="name-sort" class="filter-select">
                        <option value="default">Mặc định</option>
                        <option value="asc">Tên: A-Z</option>
                        <option value="desc">Tên: Z-A</option>
                    </select>
                </div>
                <button id="reset-filters">Xóa bộ lọc</button>
            </aside>
            <section class="services-content">
                <div class="results-header">
                    <p>Hiển thị <strong id="results-count">0</strong> kết quả</p>
                </div>
                <div class="services-grid" id="all-services-grid">
                    <p>Đang tải dịch vụ...</p>
                </div>  
                <div id="no-results-message" style="display: none;">
                    <h3>Không tìm thấy dịch vụ phù hợp</h3>
                    <p>Vui lòng thử lại với từ khóa hoặc bộ lọc khác.</p>
                </div>
                <div class="pagination" id="pagination-controls" style="display: none; margin-top: 20px; text-align: center;">
                    <button id="prev-page" disabled>Trước</button>
                    <span id="current-page-info">Trang 1 / 1</span>
                    <button id="next-page" disabled>Sau</button>
                </div>
            </section>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-top">
            <div class="container">
                <div class="footer-grid">
                    <div class="footer-widget about-widget">
                        <a href="/index.html" class="footer-logo">
                            <img src="/assets/logo/Ho_Anh_Tuan.png" alt="Logo">
                            <span>Dịch vụ Tại Nhà</span>
                        </a>
                        <p>Cung cấp các dịch vụ tại nhà chất lượng cao, uy tín và chuyên nghiệp. Hãy để chúng tôi giúp cuộc sống của bạn dễ dàng hơn.</p>
                        <div class="social-links">
                            <a href="https://www.facebook.com/ten.trang.cua.ban" target="_blank" class="social-link facebook"><i class="fab fa-facebook-f"></i></a>
                            <a href="https://www.instagram.com/ten_instagram" target="_blank" class="social-link instagram"><i class="fab fa-instagram"></i></a>
                            <a href="https://www.tiktok.com/@ten_tiktok" target="_blank" class="social-link tiktok"><i class="fab fa-tiktok"></i></a>
                            <a href="https://www.youtube.com/channel/ma_kenh_cua_ban" target="_blank" class="social-link youtube"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                    <div class="footer-widget">
                        <h3 class="widget-title">Điều hướng</h3>
                        <ul class="widget-links">
                            <li><a href="/index.html">Trang chủ</a></li>
                            <li><a href="/introduce.html">Giới thiệu</a></li>
                            <li><a href="/services.html">Dịch vụ</a></li>
                            <li><a href="/service_price_list.html">Bảng giá</a></li>
                            <li><a href="/contact.html">Liên hệ</a></li>
                        </ul>
                    </div>
                    <div class="footer-widget">
                        <h3 class="widget-title">Dịch vụ</h3>
                        <ul class="widget-links" id="footer-services"></ul>
                    </div>
                    <div class="footer-widget">
                        <h3 class="widget-title">Hỗ trợ</h3>
                        <ul class="widget-links">
                            <li><a href="/terms.html">Điều khoản sử dụng</a></li>
                            <li><a href="/privacy.html">Chính sách bảo mật</a></li>
                            <li><a href="/faq.html">Câu hỏi thường gặp</a></li>
                            <li><a href="/return_policy.html">Chính sách hoàn tiền</a></li>
                            <li><a href="/support.html">Trung tâm trợ giúp</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">
                <p>&copy; 2025 Dịch vụ Tại Nhà. All rights reserved. Thiết kế bởi Hồ Anh Tuấn</p>
            </div>
        </div>
    </footer>

    <button id="backToTop" class="back-to-top"><i class="fas fa-chevron-up"></i></button>

    <!-- CHAT SUPPORT -->
    <div class="chat-support">
        <div class="chat-icon" id="chatIcon">
            <i class="fas fa-comments"></i>
            <span class="chat-notification" style="display: none;"></span>
        </div>
        <div class="chat-box" id="chatBox">
            <div class="chat-header">
                <div class="chat-title">
                    <div class="chat-avatar"><i class="fas fa-headset"></i></div>
                    <div>
                        <h3>Hỗ trợ trực tuyến</h3>
                        <span class="online-status"><i class="fas fa-circle"></i> Đang trực tuyến</span>
                    </div>
                </div>
                <div class="chat-actions">
                    <button id="minimizeChat"><i class="fas fa-minus"></i></button>
                    <button id="closeChat"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Tin nhắn chào sẽ được thêm bằng JS -->
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." autocomplete="off">
                <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="/js/services_chatbot.js"></script>
    <script src="/js/notification.js?v=1.2"></script>
    <script>
        function getOptimizedImage(url) {
    if (!url || !url.includes('res.cloudinary.com')) {
        return url || '/assets/images/service-default.jpg';
    }
    return url.replace('/upload/', '/upload/w_400,h_300,c_fill,q_auto,f_auto/');
    }
      let allServices = [];
      let allCategories = [];
      let displayedCategoriesCount = 5;
      let currentPage = 1;
      const servicesPerPage = 6;

      // Hàm loại bỏ dấu tiếng Việt
      function removeDiacritics(str) {
          return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
      }

      // --- CÁC HÀM HIỂN THỊ GIAO DIỆN ---

      function renderServices(servicesToDisplay) {
          const servicesGrid = document.getElementById('all-services-grid');
          const resultsCount = document.getElementById('results-count');
          const noResultsMessage = document.getElementById('no-results-message');
          const paginationControls = document.getElementById('pagination-controls');
          const currentPageInfo = document.getElementById('current-page-info');
          const prevPageBtn = document.getElementById('prev-page');
          const nextPageBtn = document.getElementById('next-page');

          resultsCount.textContent = servicesToDisplay.length;

          if (servicesToDisplay.length === 0) {
              servicesGrid.innerHTML = '';
              noResultsMessage.style.display = 'block';
              paginationControls.style.display = 'none';
              return;
          }

          noResultsMessage.style.display = 'none';
          paginationControls.style.display = 'block';

          const totalPages = Math.ceil(servicesToDisplay.length / servicesPerPage);
          currentPageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
          prevPageBtn.disabled = currentPage === 1;
          nextPageBtn.disabled = currentPage === totalPages;

          const startIndex = (currentPage - 1) * servicesPerPage;
          const endIndex = startIndex + servicesPerPage;
          const paginatedServices = servicesToDisplay.slice(startIndex, endIndex);

          servicesGrid.innerHTML = paginatedServices.map(service => {
            const optimizedUrl = getOptimizedImage(service.imageURL);
              return `
            <div class="service-card">
                <div class="service-image">
                    <img src="${optimizedUrl}" alt="${service.tenDichVu}" loading="lazy">
                    <div class="service-category">${service.category ? service.category.tenDanhMuc : 'Chưa phân loại'}</div>
                </div>
                <div class="service-content">
                    <h3 class="service-title">${truncateText(service.tenDichVu, 4)}</h3>
                    <div class="service-meta">
                        <span class="service-price">${new Intl.NumberFormat('vi-VN').format(service.giaCoBan)} đ</span>
                        <span class="service-duration"><i class="far fa-clock"></i> ${service.thoiGianHoanThanh || 'N/A'} phút</span>
                    </div>
                    <p class="service-description">${truncateText(service.moTa, 5)}</p>
                    <div class="service-actions">
                        <a href="/service_detail.html?id=${service.id}" class="btn btn-outline">Chi tiết</a>
                        <a href="/booking.html?service_id=${service.id}" class="btn btn-primary">Đặt lịch</a>
                        <button class="btn-chat-mini" 
                            onclick="openChatWithService('${service.id}', '${service.tenDichVu}')"
                            title="Chat tư vấn ngay">
                            <i class="fas fa-comments"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

      function truncateText(text, maxWords) {
          if (!text) return 'Không có mô tả';
          const words = text.trim().split(/\s+/);
          if (words.length > maxWords) {
              return words.slice(0, maxWords).join(' ') + '...';
          }
          return text;
      }

      function renderCategories(categories, count = 5) {
          const categoryFilters = document.getElementById('category-filters');
          const loadMoreBtn = document.getElementById('load-more-categories');
          let categoryHTML = `
              <label>
                  <input type="radio" name="category" value="all" checked> Tất cả
              </label>
          `;
          if (Array.isArray(categories)) {
              const visibleCategories = categories.slice(0, count);
              categoryHTML += visibleCategories.map(cat => `
                  <label>
                      <input type="radio" name="category" value="${cat.id}"> ${cat.tenDanhMuc}
                  </label>
              `).join('');
          }
          categoryFilters.innerHTML = categoryHTML;

          if (count < categories.length) {
              loadMoreBtn.style.display = 'block';
          } else {
              loadMoreBtn.style.display = 'none';
          }
      }

      // --- HÀM LỌC VÀ SẮP XẾP CHÍNH ---

      function applyFilters() {
          let filteredServices = [...allServices];
          
          const searchQuery = document.getElementById('search-input').value.toLowerCase().trim();
          const selectedCategory = document.querySelector('input[name="category"]:checked').value;
          const priceSort = document.getElementById('price-sort').value;
          const nameSort = document.getElementById('name-sort').value;

          if (searchQuery) {
              const queryWithoutDiacritics = removeDiacritics(searchQuery);
              filteredServices = filteredServices.filter(service => 
                  removeDiacritics(service.tenDichVu.toLowerCase()).includes(queryWithoutDiacritics)
              );
          }

          if (selectedCategory !== 'all') {
              filteredServices = filteredServices.filter(service => 
                  service.category && service.category.id == selectedCategory
              );
          }

          if (priceSort !== 'default') {
              if (priceSort === 'asc') {
                  filteredServices.sort((a, b) => Number(a.giaCoBan) - Number(b.giaCoBan));
              } else {
                  filteredServices.sort((a, b) => Number(b.giaCoBan) - Number(a.giaCoBan));
              }
          } else if (nameSort !== 'default') {
              if (nameSort === 'asc') {
                  filteredServices.sort((a, b) => a.tenDichVu.localeCompare(b.tenDichVu, 'vi'));
              } else {
                  filteredServices.sort((a, b) => b.tenDichVu.localeCompare(a.tenDichVu, 'vi'));
              }
          }
          
          renderServices(filteredServices);
      }

      // --- GÁN CÁC SỰ KIỆN CHO BỘ LỌC ---

      function setupEventListeners() {
          const searchInput = document.getElementById('search-input');
          const categoryFilters = document.getElementById('category-filters');
          const priceSort = document.getElementById('price-sort');
          const nameSort = document.getElementById('name-sort');
          const resetBtn = document.getElementById('reset-filters');
          const loadMoreCategories = document.getElementById('load-more-categories');
          const prevPageBtn = document.getElementById('prev-page');
          const nextPageBtn = document.getElementById('next-page');
          
          searchInput.addEventListener('input', applyFilters);
          categoryFilters.addEventListener('change', applyFilters);
          


          priceSort.addEventListener('change', () => {
              nameSort.value = 'default';
              applyFilters();
          });
          
          nameSort.addEventListener('change', () => {
              priceSort.value = 'default';
              applyFilters();
          });

          resetBtn.addEventListener('click', () => {
              searchInput.value = '';
              document.querySelector('input[name="category"][value="all"]').checked = true;
              priceSort.value = 'default';
              nameSort.value = 'default';
              currentPage = 1;
              applyFilters();
          });

          loadMoreCategories.addEventListener('click', () => {
              displayedCategoriesCount += 5;
              renderCategories(allCategories, displayedCategoriesCount);
          });

          prevPageBtn.addEventListener('click', () => {
              if (currentPage > 1) {
                  currentPage--;
                  applyFilters();
              }
          });

          nextPageBtn.addEventListener('click', () => {
              const totalPages = Math.ceil(allServices.length / servicesPerPage);
              if (currentPage < totalPages) {
                  currentPage++;
                  applyFilters();
              }
          });
      }

      // --- HÀM KHỞI TẠO CHÍNH CỦA TRANG ---

      async function initializeServicesPage() {
    try {
        fetch('/api/categories')
            .then(res => res.json())
            .then(data => {
                allCategories = Array.isArray(data) ? data : [];
                renderCategories(allCategories, displayedCategoriesCount);
            })
            .catch(err => console.error("Lỗi tải danh mục:", err));

        const servicesResponse = await fetch('/api/services?page=0&size=100');
        
        if (!servicesResponse.ok) throw new Error('Lỗi mạng khi tải dữ liệu.');
        
        const servicesData = await servicesResponse.json();
        allServices = Array.isArray(servicesData.content) ? servicesData.content : [];
        
        applyFilters(); // Hiển thị dữ liệu dịch vụ
        setupEventListeners();

    } catch (error) {
        console.error('Lỗi khi khởi tạo trang dịch vụ:', error);
        document.getElementById('all-services-grid').innerHTML = 
            '<p style="text-align: center; color: red;">Đã xảy ra lỗi khi tải dịch vụ.</p>';
    }
}

      function loadAuthSection() {
          const token = localStorage.getItem('jwtToken');
          const authSection = document.getElementById('auth-section');

          if (token) {
              fetch('/api/users/me', { headers: { 'Authorization': `Bearer ${token}` } })
              .then(response => {
                  if (!response.ok) throw new Error('Unauthorized');
                  return response.json();
              })
              .then(user => {
                  const avatar = user.avatarURL || '/assets/avatar/default-avatar.png';
                  const displayName = user.hoTen || 'Người dùng';
                  authSection.innerHTML = `
                      <div class="header-actions">
                          <div class="notification-container">
                              <div class="notification-icon"><i class="fas fa-bell"></i><span class="notification-badge" style="display: none;"></span></div>
                              <div class="notification-dropdown">
                                  <div class="notification-header"><h3>Thông báo</h3><button class="mark-all-read">Đánh dấu đã đọc</button></div>
                                  <div class="notification-list" id="notification-list"></div>
                                  <div class="notification-footer"><a href="/notifications.html">Xem tất cả</a></div>
                              </div>
                          </div>
                          <div class="user-menu-container">
                              <div class="user-menu-trigger">
                                  <img src="${avatar}" alt="Avatar" class="user-avatar">
                                  <span class="user-name">${displayName}</span>
                                  <i class="fas fa-chevron-down"></i>
                              </div>
                              <div class="user-dropdown">
                                  <a href="/account.html" class="user-dropdown-item"><i class="fas fa-user"></i> Hồ sơ cá nhân</a>
                                  <a href="/my_bookings.html" class="user-dropdown-item"><i class="fas fa-calendar-check"></i> Đơn đặt dịch vụ</a>
                                  <a href="/cart.html" class="user-dropdown-item"><i class="fas fa-shopping-cart"></i> Giỏ hàng của tôi</a>
                                  <a href="/change_password.html" class="user-dropdown-item"><i class="fas fa-key"></i> Đổi mật khẩu</a>
                                  <div class="dropdown-divider"></div>
                                  <a href="#" class="user-dropdown-item logout" onclick="logout(event)"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
                              </div>
                          </div>
                      </div>`;
                      const initialCount = localStorage.getItem('unreadNotificationCount') || 0;
                
                updateBadgeCount(initialCount);
                loadNotifications(token);
                setupNotificationClick();
              })
              .catch(() => {
                  localStorage.removeItem('jwtToken');
                  authSection.innerHTML = `<div class="auth-buttons"><a href="/login.html" class="btn btn-outline">Đăng nhập</a><a href="/register.html" class="btn btn-primary">Đăng ký</a></div>`;
              });
          } else {
              authSection.innerHTML = `<div class="auth-buttons"><a href="/login.html" class="btn btn-outline">Đăng nhập</a><a href="/register.html" class="btn btn-primary">Đăng ký</a></div>`;
          }
      }

      function logout(event) {
          event.preventDefault();
          localStorage.removeItem('jwtToken');
          localStorage.removeItem('userRole');
          window.location.href = '/login.html';
      }

      function loadFooterServices() {
          fetch('/api/services?page=0&size=5')
          .then(response => response.json())
          .then(services => {
              const footerServices = document.getElementById('footer-services');
              if (footerServices) {
                  const data = Array.isArray(services.content) ? services.content : (Array.isArray(services) ? services : []);
                  footerServices.innerHTML = data.map(service => `
                      <li><a href="/service_detail.html?id=${service.id}">${truncateText(service.tenDichVu, 4)}</a></li>
                  `).join('');
              }
          }).catch(error => console.error('Lỗi lấy dịch vụ footer:', error));
      }

      document.addEventListener('DOMContentLoaded', () => {
          loadAuthSection();
          loadFooterServices();
          initializeServicesPage();

          // KHỞI TẠO CHATBOT
          if (typeof initChatbot === 'function') {
              initChatbot();
          }
      });
    </script>
</body>
</html>